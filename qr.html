<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pedido Registrado</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2em; }
    #qr { margin: 1em auto; }
    #info { margin-top: 2em; font-size: 1.2em; }
  </style>
</head>
<body>
  <h2>Pedido Registrado</h2>
  <canvas id="qr"></canvas>
  <div id="info">Cargando pedido...</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const cedula = params.get("cedula")?.trim();

    const qr = new QRious({
      element: document.getElementById("qr"),
      value: cedula,
      size: 200
    });

    const SHEET_ID = '1Apfz0KugvEMqks7jVsby1VCOUC-MW8k_d2YxlpRbRkc';
    const SHEET_NAME = 'Entrada';
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

    fetch(url)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows;

        // Buscar el último pedido con esa cédula en la columna F (índice 5)
        const pedido = rows
          .map(r => r.c.map(c => c ? c.v.toString().trim() : ""))
          .filter(r => r[5] === cedula)
          .pop();  // tomar el último

        if (pedido) {
          const [fecha, nombre, cedulaReal, producto, precio, , entregado] = pedido;
          document.getElementById("info").innerHTML = `
            <strong>Nombre:</strong> ${nombre}<br>
            <strong>Cédula:</strong> ${cedulaReal}<br>
            <strong>Producto:</strong> ${producto}<br>
            <strong>Precio:</strong> $${precio}<br>
            <strong>Entregado:</strong> ${entregado || 'No'}
          `;
        } else {
          document.getElementById("info").innerText = "No se encontró el pedido para esta cédula.";
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById("info").innerText = "Error al cargar los datos.";
      });
  </script>
</body>
</html>
